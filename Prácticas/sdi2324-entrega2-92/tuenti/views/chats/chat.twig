{% extends "../layout.twig" %}
{% block title %}Chat online{% endblock %}
{% block main_container %}
    <script src="/socket.io/socket.io.js"></script>
    <h2>Chat con {{ friendName }}</h2>
<div id="chatContainer">
    {% for message in messages %}
        <div class="messageContainer">
            <p>{{ message.content }}</p>
            <p>{{ message.timestamp }}</p>
        </div>
    {% endfor %}
</div>

<label for="m"></label><input id="m" autocomplete="off" /><button id="sendBtn">Enviar</button>
<script>
    var userId = "{{userId}}";
    var friendId = "{{friendId}}";
    var roomName = userId < friendId ? `${userId}-${friendId}` : `${friendId}-${userId}`;

    document.getElementById('sendBtn').addEventListener('click', function() {
        var msg = document.getElementById('m').value;

        sendMessage(userId, friendId, msg, roomName);
        document.getElementById('m').value = '';
    });
</script>

<script>

    //estaba en otro archivo pero falla y no voy a dar vueltas
    const url= 'http://localhost:8081';
    var socket = io(url);
    //cuando entras al chat ya esta en la sala
    socket.on('connect', function() {
        console.log('Conectado al servidor');
        socket.emit('joinRoom', { user1Id: userId, user2Id: friendId });
    });

    socket.on('disconnect', function() {
        console.log('Desconectado del servidor');
    });

    socket.on('chat message', function(msg) {
        console.log('Mensaje recibido: ' + msg);
    });


    socket.on('chatUpdated', () => {
        console.log('Chat actualizado usuario y amigo ',userId,friendId);
        fetch(`/chat/${userId}/${friendId}/messages`)
            .then(response => response.json())
            .then(data => {
                //actualizzr el div d elos mensajes
                updateMessages(data);
            })
            .catch(error => console.error('Error:', error));
    });
    function sendMessage(user1Id, user2Id, msg, roomName) {
        socket.emit('chat-message', { user1Id, user2Id, message: msg, roomName });
        console.log('Mensaje enviado: ' + msg);
    }


    function updateMessages(messages) {
        // AquÃ­ puedes actualizar la lista de mensajes en la interfaz de usuario

        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = '';
        messages.forEach(message => {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'messageContainer';
            const messageElement = document.createElement('p');
            messageElement.textContent = message.content;
            const timestampElement = document.createElement('p');
            timestampElement.textContent = message.timestamp;
            messageContainer.appendChild(messageElement);
            messageContainer.appendChild(timestampElement);
            chatContainer.appendChild(messageContainer);
        });


    }
</script>
{% endblock %}
